<!DOCTYPE html>
<html lang="cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扫雷测试</title>
    <style>
        body {
            display: grid;
            background-color: #F0F0F0;
            justify-content: center;
        }

       .box {
            display: flex;
            flex-wrap: wrap;
        }

       .time {
            display: inline-block;
            font-size: 14px;
        }

       .item {
            border: 1px solid #ddd;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

       .circle {
            border: 10px solid #a33939;
            border-radius: 100%;
        }

       .hide {
            background-color: #D3D3D3;
            border-top: 2px solid white;
            border-left: 2px solid white;
            border-right: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
        }

       .hide > * {
            display: none;
        }

       .info::after {
            position: relative;
            top: 2px;
            left: 1px;
            content: url(data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEA8ADwAAD/4QAiRXhpZgAATU0AKgAAAAgAAQESAAMAAAABAAEAAAAAAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAcABwDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD7grw/4xf8FA/h78LtDv5bDUD4r1K0VtttphDQEqpJ3XB/dgcYJQuQeCBg49k8QaDaeKdBvtMv4vPsdRt5LW4i3MvmRupVlypBGQSMgg18aftc/wDBPzQPhX+z/wCLfF3h/XdSik8MaLe6nfRakI5hcQQQNKQjxxqUZQr8FXDFh93B3eLnNXMIQX1GKffv8l/w/ofqHhdl3BWKxclxfiJ019iMVaEtH8c1eS1tZJR1teVr2+16KKK9o/KzL8b6hquk+C9XutC06DV9btrKaXT7Ga4FtHe3CxsYoWlIPlq7hVL4O0HODivyn/bM/Zs/b2/a/wDGepXcunJ4O8PX9g2lyeHfD/jfyNNurZt4ZZojc7JXdXKOzKAygDaOlfrYDj8ad5jepoGnY/Pr/gm5of7Zn7Ol6nhn4oeEYPHnhjWNVW5n1vVvGy3Oq6KspgjkKs0kvmwRRpJIIFVS0jnDjca/QQHHYUolYd6aTuJJ6mgGz//Z);
            height: 30px;
            width: 30px;
        }

       .message {
            display: inline-block;
            font-size: 14px;
        }

       .number-1 {
            color: blue;
        }

       .number-2 {
            color: green;
        }

       .number-3 {
            color: red;
        }

       .number-4 {
            color: darkblue;
        }

       .number-5 {
            color: purple;
        }

       .number-6 {
            color: teal;
        }

       .number-7 {
            color: black;
        }

       .number-8 {
            color: gray;
        }
    </style>
</head>

<body>
    <div style="display: flex; justify-content: space-between;">
        <div class="message"></div>
        <div class="time"></div>
    </div>
    <div class="box"></div>
    <script>
// 初始化游戏参数
const rows = 20;
const cols = 20;
const size = 30;
let minesCount = 0;
const mines = {};
const Xnum = [];
const Ynum = [];
let time_ = 0;

// 生成雷区
while (Ynum.length < 20) {
    const j = Math.floor(Math.random() * rows);
    const k = Math.floor(Math.random() * cols);
    if (!Xnum.includes(j) || !Ynum.includes(k)) {
        Xnum.push(j);
        Ynum.push(k);
    }
}
Xnum.forEach((i, index) => mines[`${i}-${Ynum[index]}`] = 1);

// 计算每个格子的数字
const calculateNumber = (i, j) => {
    return Object.values({
        0: mines[`${i - 1}-${j - 1}`],
        1: mines[`${i - 1}-${j}`],
        2: mines[`${i - 1}-${j + 1}`],
        3: mines[`${i}-${j - 1}`],
        4: mines[`${i}-${j + 1}`],
        5: mines[`${i + 1}-${j - 1}`],
        6: mines[`${i + 1}-${j}`],
        7: mines[`${i + 1}-${j + 1}`],
    }).filter(Boolean).length;
};

// 初始化界面
const box = document.querySelector('.box');
const message = document.querySelector('.message');
message.innerHTML = `地雷：<div class="number-3">${minesCount}</div>`;
const timeDiv = document.querySelector('.time');

// 生成雷区网格
const generateGrid = () => {
    const result = [];
    for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
            const isMine = mines[`${i}-${j}`];
            const number = calculateNumber(i, j);
            result.push(`
                <div class="item hide" data-v="${i}-${j}" 
                    style="width:${size}px;height:${size}px">
                    ${isMine ? '<div class="circle"></div>' : 
                        `<div class="number number-${number}">${number || ''}</div>`}
                </div>
            `);
        }
    }
    return result.join('');
};

// 初始化游戏
const initGame = () => {
    box.innerHTML = generateGrid();
    box.style.width = `${cols * size}px`;
    box.style.height = `${rows * size}px`;
    time_ = 0;
    timeDiv.innerHTML = `时间：<div class="number-3">0</div>`;
    startTimer();
};

// 开始计时
let intervalId;
const startTimer = () => {
    intervalId = setInterval(() => {
        time_++;
        timeDiv.innerHTML = `时间：<div class="number-3">${time_}</div>`;
    }, 1000);
};

// 游戏结束处理
const gameOver = (isWin) => {
    clearInterval(intervalId);
    box.querySelectorAll('.item').forEach(item => {
        item.classList.remove('hide');
    });
    alert(isWin ? '恭喜你！胜利了！' : '很遗憾，你被炸了！');
};

// 展开空白区域
const expandArea = (el) => {
    const indexs = el.getAttribute('data-v').split('-').map(Number);
    const queue = [indexs];
    
    while (queue.length) {
        const [i, j] = queue.shift();
        for (let x = -1; x <= 1; x++) {
            for (let y = -1; y <= 1; y++) {
                if (x === 0 && y === 0) continue;
                const ni = i + x;
                const nj = j + y;
                if (ni >= 0 && ni < rows && nj >= 0 && nj < cols) {
                    const neighbor = document.querySelector(`[data-v="${ni}-${nj}"]`);
                    if (neighbor && neighbor.classList.contains('hide') && !neighbor.classList.contains('info')) {
                        neighbor.classList.remove('hide');
                        const number = neighbor.querySelector('.number').textContent;
                        if (number === '') queue.push([ni, nj]);
                    }
                }
            }
        }
    }
};

// 处理数字点击
const handleNumberClick = (el, indexs) => {
    const neighbors = [
        [indexs[0] - 1, indexs[1] - 1],
        [indexs[0] - 1, indexs[1]],
        [indexs[0] - 1, indexs[1] + 1],
        [indexs[0], indexs[1] - 1],
        [indexs[0], indexs[1] + 1],
        [indexs[0] + 1, indexs[1] - 1],
        [indexs[0] + 1, indexs[1]],
        [indexs[0] + 1, indexs[1] + 1],
    ];
    
    const markedCount = neighbors.filter(([i, j]) => 
        document.querySelector(`[data-v="${i}-${j}"]`)?.classList.contains('info')
    ).length;
    
    if (markedCount === parseInt(el.textContent)) {
        neighbors.forEach(([i, j]) => {
            const neighbor = document.querySelector(`[data-v="${i}-${j}"]`);
            if (neighbor && neighbor.classList.contains('hide') && !neighbor.classList.contains('info')) {
                neighbor.classList.remove('hide');
                if (neighbor.querySelector('.number').textContent === '') {
                    expandArea(neighbor);
                }
            }
        });
    }
};

// 初始化事件绑定
const initEvents = () => {
    box.querySelectorAll('.item').forEach(v => {
        let timeoutId = null;
        
        // 触摸开始
        v.addEventListener('touchstart', (e) => {
            e.preventDefault();
            timeoutId = setTimeout(() => {
                if (v.classList.contains('hide')) {
                    v.classList.toggle('info');
                    message.textContent = `地雷：${minesCount - [...box.querySelectorAll('.info')].length}`;
                }
            }, 500);
        });

        // 触摸结束
        v.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearTimeout(timeoutId);
            if (timeoutId) {
                if (v.classList.contains('info')) return;
                
                v.classList.remove('hide');
                if (v.querySelector('.circle')) {
                    gameOver(false);
                } else {
                    const number = v.querySelector('.number').textContent;
                    if (number === '') {
                        expandArea(v);
                    } else {
                        handleNumberClick(v, v.getAttribute('data-v').split('-').map(Number));
                    }
                    
                    if (minesCount === [...box.querySelectorAll('.hide')].length) {
                        gameOver(true);
                    }
                }
            }
            timeoutId = null;
        });

        // 触摸移动
        v.addEventListener('touchmove', (e) => {
            e.preventDefault();
            clearTimeout(timeoutId);
            timeoutId = null;
        });

        // 桌面端事件
        v.addEventListener('click', (e) => {
            if (e.button === 0 && !v.classList.contains('info')) {
                v.classList.remove('hide');
                if (v.querySelector('.circle')) {
                    gameOver(false);
                } else {
                    const number = v.querySelector('.number').textContent;
                    if (number === '') {
                        expandArea(v);
                    } else {
                        handleNumberClick(v, v.getAttribute('data-v').split('-').map(Number));
                    }
                    
                    if (minesCount === [...box.querySelectorAll('.hide')].length) {
                        gameOver(true);
                    }
                }
            }
        });

        v.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (v.classList.contains('hide')) {
                v.classList.toggle('info');
                message.textContent = `地雷：${minesCount - [...box.querySelectorAll('.info')].length}`;
            }
        });
    });
};

// 初始化游戏
initGame();
initEvents();
    </script>
</body>

</html>    
